version: '3.8'

services:
  yral-metadata:
    image: ${APP_IMAGE:-ghcr.io/dolr-ai/yral-metadata}:${IMAGE_TAG:-latest}
    container_name: yral-metadata
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - BIND_ADDRESS=0.0.0.0:8080 
      - JWT_PUBLIC_KEY=${JWT_PUBLIC_KEY}
      - YRAL_METADATA_USER_NOTIFICATION_API_KEY=${YRAL_METADATA_USER_NOTIFICATION_API_KEY}
      - CLIENT_NOTIFICATIONS_GOOGLE_SERVICE_ACCOUNT_KEY=${CLIENT_NOTIFICATIONS_GOOGLE_SERVICE_ACCOUNT_KEY}
      - GOOGLE_CLIENT_NOTIFICATIONS_PROJECT_ID=${GOOGLE_CLIENT_NOTIFICATIONS_PROJECT_ID}
      - BACKEND_ADMIN_IDENTITY=${BACKEND_ADMIN_IDENTITY}
      - YRAL_AUTH_PUBLIC_KEY=${YRAL_AUTH_PUBLIC_KEY}
      - GOOGLE_CLIENT_NOTIFICATIONS_SENDER_ID=${GOOGLE_CLIENT_NOTIFICATIONS_SENDER_ID}
      - QSTASH_CURRENT_SIGNING_KEY=${QSTASH_CURRENT_SIGNING_KEY}
      - QSTASH_NEXT_SIGNING_KEY=${QSTASH_NEXT_SIGNING_KEY}
      - DRAGONFLY_PASSWORD=${DRAGONFLY_PASSWORD}
      - DRAGONFLY_HOSTS=${DRAGONFLY_HOSTS}
      - DRAGONFLY_CA_CERT=${DRAGONFLY_CA_CERT}
      - DRAGONFLY_CLIENT_CERT=${DRAGONFLY_CLIENT_CERT}
      - DRAGONFLY_CLIENT_KEY=${DRAGONFLY_CLIENT_KEY}
    networks:
      - yral-net

  caddy:
      image: caddy:2-alpine
      restart: unless-stopped
      ports:
        - "80:80"
        - "443:443"
      volumes:
        - ./Caddyfile:/etc/caddy/Caddyfile:ro
        - caddy_data:/data
        - caddy_config:/config
      networks:
        - yral-net
      depends_on:
        - yral-metadata
        
networks:
  yral-net:
    driver: bridge

volumes:
  caddy_data:
  caddy_config: