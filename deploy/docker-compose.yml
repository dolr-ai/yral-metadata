version: '3.8'

services:
  fly-redis-proxy:
    image: ${PROXY_IMAGE:-ghcr.io/dolr-ai/fly-redis-proxy}:${IMAGE_TAG:-latest}
    restart: unless-stopped
    environment:
      - FLY_API_TOKEN=${FLY_API_TOKEN}
    networks:
      - yral-net
    healthcheck:
      test: ["CMD", "nc", "-z", "127.0.0.1", "16379"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 60s

  yral-metadata:
    image: ${APP_IMAGE:-ghcr.io/dolr-ai/yral-metadata}:${IMAGE_TAG:-latest}
    container_name: yral-metadata
    restart: unless-stopped
    ports:
      - "8080:8080"
    environment:
      - BIND_ADDRESS=0.0.0.0:8080 
      - FLY_API_TOKEN=${FLY_API_TOKEN} 
      - REDIS_URL=${REDIS_URL} 
      - JWT_PUBLIC_KEY=${JWT_PUBLIC_KEY}
      - YRAL_METADATA_USER_NOTIFICATION_API_KEY=${YRAL_METADATA_USER_NOTIFICATION_API_KEY}
      - CLIENT_NOTIFICATIONS_GOOGLE_SERVICE_ACCOUNT_KEY=${CLIENT_NOTIFICATIONS_GOOGLE_SERVICE_ACCOUNT_KEY}
      - GOOGLE_CLIENT_NOTIFICATIONS_PROJECT_ID=${GOOGLE_CLIENT_NOTIFICATIONS_PROJECT_ID}
      - BACKEND_ADMIN_IDENTITY=${BACKEND_ADMIN_IDENTITY}
      - YRAL_AUTH_PUBLIC_KEY=${YRAL_AUTH_PUBLIC_KEY}
      - GOOGLE_CLIENT_NOTIFICATIONS_SENDER_ID=${GOOGLE_CLIENT_NOTIFICATIONS_SENDER_ID}
      - QSTASH_CURRENT_SIGNING_KEY=${QSTASH_CURRENT_SIGNING_KEY}
      - QSTASH_NEXT_SIGNING_KEY=${QSTASH_NEXT_SIGNING_KEY}
    networks:
      - yral-net
    depends_on:
      - fly-redis-proxy

  caddy:
      image: caddy:2-alpine
      restart: unless-stopped
      ports:
        - "80:80"
        - "443:443"
      volumes:
        - ./Caddyfile:/etc/caddy/Caddyfile:ro
        - caddy_data:/data
        - caddy_config:/config
      networks:
        - yral-net
      depends_on:
        - yral-metadata
        
networks:
  yral-net:
    driver: bridge

volumes:
  caddy_data:
  caddy_config: